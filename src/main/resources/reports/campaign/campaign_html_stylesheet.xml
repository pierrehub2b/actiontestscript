<?xml version="1.0" encoding="UTF-8" ?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
	<xsl:output method="html" version="5.0" encoding="UTF-8" indent="yes" />
	<!-- ========================= -->
	<!-- Calculations    -->
	<!-- ========================= -->
	<xsl:variable name="nbtests" select="count(//report/tests/ats)" />
	<xsl:variable name="nbkos" select="count(//report/tests/ats/actions/action[passed = 'false'])" />
	<xsl:variable name="nbpassed" select="$nbtests - $nbkos" />
	<xsl:variable name="xml_reports" select="//report/suite/parameter[@name='xml.report']/@value" />
	<xsl:variable name="atsv_reports" select="//report/suite/parameter[@name='visual.report']/@value" />
	<xsl:variable name="ats_loglevel" select="//report/suite/parameter[@name='ats.log.level']/@value" />
	<xsl:variable name="actions" select="//report/@actions" />
	<xsl:variable name="details" select="//report/@details" />
	<!-- ========================= -->
	<!-- Appel du template: ats -->
	<!-- ========================= -->
	<xsl:template match="report">
		<HTML LANG="en">
			<HEAD>
				<META charset="utf-8" />
				<META name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
				<META name="description" content="" />
				<TITLE>Ats suites reporting</TITLE>
				<LINK rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" />
				<LINK rel="stylesheet" href="report.css" />
			</HEAD>
			<BODY class="py-4">

				<TABLE class="execution table table-borderless">
					<TBODY>
						<TR style="display:grid;">
							<TH class="align-middle text-center">
								<IMG src="logo.png" />
							</TH>
							<TH class="align-middle text-center">
								<H1>
                              ActionTestScript - Suites Result
                          </H1>
							</TH>
						</TR>
					</TBODY>
				</TABLE>

				<DIV class="container">
					<xsl:apply-templates />
				</DIV>
			</BODY>
			<script src="script.js"></script>
		</HTML>
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: suite     -->
	<!-- ========================= -->
	<xsl:template match="suite">
		<hr style="height: 10px; background-color:black;margin-top:100px" />
		<TABLE class="execution table table-bordered table-hover" style="background-color:#EBEBEB">
			<TBODY>
				<TR>
					<TD class="w-25 p-3">
            Execution : 
          </TD>
					<TD>
						<H3>
							<xsl:value-of select="@name" />
						</H3>
					</TD>

					<TD class="align-middle text-center">
						<xsl:text disable-output-escaping="yes">&lt;A target=&quot;_blank&quot; href=&quot;</xsl:text>
						<xsl:value-of select="concat('ats-report.pdf')" />
						<xsl:text disable-output-escaping="yes">&quot; class=&quot;btn btn-secondary btn-sm &quot; role=&quot;button&quot; aria-pressed=&quot;true&quot;&gt;PDF report&lt;/a&gt;</xsl:text>
					</TD>

				</TR>
				<TR>
					<TD class="w-25 p-3">
            Parameters :
          </TD>
					<TD COLSPAN="2">
						<xsl:choose>
							<xsl:when test="$xml_reports = 'true'">
								XML/PDF Report generation
								<BR />
							</xsl:when>
						</xsl:choose>
						<xsl:choose>
							<xsl:when test="$atsv_reports &gt; 0">
								ATSV Report level :
								<xsl:value-of select="$atsv_reports" />
								<BR />
							</xsl:when>
						</xsl:choose>
						ATS log level :
						<xsl:value-of select="$ats_loglevel" />
						<BR />
					</TD>
				</TR>
				<xsl:apply-templates select="test" />
			</TBODY>
		</TABLE>
		<TABLE class="result table table-bordered table-hover" style="background-color:#EBEBEB">
			<TBODY>
				<TR>
					
					<TD>
						Nb tests :
						<xsl:value-of select="$nbtests" />
					</TD>
					<TD>
						Nb passed :
						<xsl:value-of select="$nbpassed" />
					</TD>
					<TD>
						Nb KOs :
						<xsl:value-of select="$nbkos" />
					</TD>
					<xsl:choose>
						<xsl:when test="$nbkos &gt; 0">
							<TD class="test-failed" COLSPAN="3" STYLE="text-align: center;">
								<IMG src="false.png" />
							</TD>
						</xsl:when>
						<xsl:when test="$nbkos = 0">
							<TD class="test-passed" COLSPAN="3" STYLE="text-align: center;">
								<IMG src="true.png" />
							</TD>
						</xsl:when>
					</xsl:choose>
				</TR>
			</TBODY>
		</TABLE>
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: test     -->
	<!-- ========================= -->
	<xsl:template match="test">
		<TR>
			<xsl:apply-templates select="groups" />
			<xsl:apply-templates select="packages" />
		</TR>
	</xsl:template>

	<!-- ========================= -->
	<!-- child element: summary     -->
	<!-- ========================= -->
	<xsl:template match="summary">
		<b>Actions: </b>
		<xsl:value-of select="@actions" />
		<br />
		<b>Passed: </b>
		<xsl:value-of select="@status" />
		<br />
		<b>Data: </b>
		<xsl:value-of select="data" />
	</xsl:template>


	<!-- ========================= -->
	<!-- child element: groups     -->
	<!-- ========================= -->
	<xsl:template match="groups">
		<TD>
      Groups :
    </TD>
		<TD>
			<xsl:apply-templates select="run" />
		</TD>
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: run     -->
	<!-- ========================= -->
	<xsl:template match="run">
		<xsl:apply-templates select="include" />
		<xsl:apply-templates select="exclude" />
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: packages     -->
	<!-- ========================= -->
	<xsl:template match="packages">
		<TD>
      Packages :
    </TD>
		<TD>
			<xsl:apply-templates select="package" />
		</TD>
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: package     -->
	<!-- ========================= -->
	<xsl:template match="package">
		<xsl:apply-templates select="include" />
		<xsl:apply-templates select="exclude" />
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: include     -->
	<!-- ========================= -->
	<xsl:template match="include">
		<xsl:value-of select="@name" />
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: exclude     -->
	<!-- ========================= -->
	<xsl:template match="exclude">
		<xsl:value-of select="@name" />
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: classes     -->
	<!-- ========================= -->
	<xsl:template match="classes">
		<TD class="w-25 p-3">
      Tests :
    </TD>
		<TD COLSPAN="2">
			<xsl:apply-templates select="class" />
		</TD>
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: class     -->
	<!-- ========================= -->
	<xsl:template match="class">
		<SPAN>
			<xsl:value-of select="@name" />
			<xsl:text></xsl:text>
		</SPAN>
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: tests     -->
	<!-- ========================= -->
	<xsl:template match="tests">
		<xsl:apply-templates select="ats" />
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: ats     -->
	<!-- ========================= -->
	<xsl:template match="ats">
		<xsl:variable name="test_result" select="count(actions/action[passed = 'false'])" />
		<xsl:variable name="test_file" select="concat(script[1]/@suiteName, '/', script[1]/@testName, '_xml/', script[1]/@testName, '_xml')" />
		<xsl:variable name="atsv_test_file" select="concat(script[1]/@suiteName, '/', script[1]/@testName)" />
		<hr style="height: 5px; background-color:black; margin-top:100px" />
		
		<h2>Name: <xsl:value-of select="script/@testName" /></h2>
		
		<TABLE class="results table table-bordered table-hover" style="background-color:#C4C4C4">
			<THEAD>
				<TR>
					<TH class="w-auto p-4">
            			Duration (ms)
	  				</TH>
	  				<TH class="w-auto p-4">
            			Actions
	  				</TH>
					<TH class="w-auto p-4">
	    				Links
	 				</TH>
					<TH class="w-auto p-4">
            			Result
	  				</TH>
				</TR>
			</THEAD>
			<TBODY>
				<TR>
					<TD>
						<xsl:value-of select="sum(actions/action/duration)" />
					</TD>
					
					<TD>
						<xsl:value-of select="script/summary/@actions" />
					</TD>
					
					<TD class="align-middle text-center linkButtons">
						<xsl:text disable-output-escaping="yes">&lt;A target=&quot;_blank&quot; href=&quot;</xsl:text>
						<xsl:value-of select="concat($test_file,'.html')" />
						<xsl:text disable-output-escaping="yes">&quot; class=&quot;btn btn-secondary btn-sm &quot; role=&quot;button&quot; aria-pressed=&quot;true&quot;&gt;HTML report&lt;/a&gt;</xsl:text>
					<xsl:choose>
						<xsl:when test="$xml_reports = 'true' or $xml_reports &gt; 0">
								<xsl:text disable-output-escaping="yes">&lt;A target=&quot;_blank&quot; href=&quot;</xsl:text>
								<xsl:value-of select="concat($test_file,'.pdf')" />
								<xsl:text disable-output-escaping="yes">&quot; class=&quot;btn btn-secondary btn-sm &quot; role=&quot;button&quot; aria-pressed=&quot;true&quot;&gt;PDF report&lt;/a&gt;</xsl:text>
						</xsl:when>
					</xsl:choose>
					<xsl:choose>
						<xsl:when test="$atsv_reports &gt; 0">
								<xsl:text disable-output-escaping="yes">&lt;A target=&quot;_blank&quot; href=&quot;</xsl:text>
								<xsl:value-of select="concat($atsv_test_file,'.atsv')" />
								<xsl:text disable-output-escaping="yes">&quot; class=&quot;btn btn-secondary btn-sm &quot; role=&quot;button&quot; aria-pressed=&quot;true&quot;&gt;ATSV report&lt;/a&gt;</xsl:text>
							
						</xsl:when>
					</xsl:choose>
					</TD>

					<xsl:choose>
						<xsl:when test="script/summary/@status = '0'">
							<TD class="test-failed">
								<IMG src="false.png" />
							</TD>
						</xsl:when>
						<xsl:when test="script/summary/@status = '1'">
							<TD class="test-passed">
								<IMG src="true.png" />
							</TD>
						</xsl:when>
					</xsl:choose>

				</TR>
				<xsl:choose>
						<xsl:when test="script/summary/data != '[empty]'">
				<TR>
					<TD colspan="8">
						<xsl:text><xsl:value-of select="script/summary/data" disable-output-escaping="yes"/></xsl:text>
					</TD>
				</TR>
				</xsl:when>
					</xsl:choose>
					<xsl:choose>
						<xsl:when test="script/summary/error != ''">
				<TR>
					<TD colspan="8">
						<xsl:text disable-output-escaping="yes">&lt;b&gt;Error in script &lt;/b&gt;<xsl:value-of select="concat('&lt;i&gt;(', script/summary/error/@script, ')&lt;/i&gt;&#160;:&#160;')" disable-output-escaping="yes"/><xsl:value-of select="script/summary/error" disable-output-escaping="yes"/></xsl:text>
						</TD>
				</TR>
				</xsl:when>
					</xsl:choose>
			</TBODY>
		</TABLE>
		

		<xsl:choose>
			<xsl:when test="$actions = 'true'">
				<xsl:apply-templates select="actions" />
			</xsl:when>
		</xsl:choose>


		<hr style="height: 5px; background-color:black; margin-bottom:100px" />
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: script     -->
	<!-- ========================= -->
	<xsl:template match="script">
		<TD>
			<xsl:value-of select="@testName" />
		</TD>
		<TD>
			<xsl:value-of select="@osInfo" />
		</TD>
	</xsl:template>
	<!-- ========================= -->
	<!-- child element: actions    -->
	<!-- ========================= -->
	<xsl:template match="actions">
		<xsl:apply-templates select="action" />
	</xsl:template>

	<!-- ========================= -->
	<!-- child element: action     -->
	<!-- ========================= -->
	<xsl:template match="action">
		
		<div class="collapsible">
			<div id="textContent">
				<xsl:value-of select="@type" />
			</div>
			
			<div id="imgContent">
				<xsl:choose>
					<xsl:when test="passed = 'true'">
						<IMG src="true.png" class='actionStatusImg' />
					</xsl:when>
					<xsl:when test="passed = 'warning'">
						<IMG src="warning.png" class='actionStatusImg' />
					</xsl:when>
					<xsl:when test="passed = 'false'">
						<IMG src="false.png" class='actionStatusImg' />
					</xsl:when>
				</xsl:choose>
			</div>
		</div>
	
		<xsl:choose>
					<xsl:when test="$details = 'true'">
		<div class="content">
			<TABLE class="results table table-bordered table-hover" style="background-color:#EBEBEB">
				<THEAD>
					<TH class="w-75 p-3">
						Action :
						<xsl:value-of select="@type" />
					</TH>
				</THEAD>
						<TBODY>
							<TR>
								<TD class="w-100 p-3" COLSPAN="2">
									<xsl:variable name="img" select="concat(@suiteName, '/', @scriptName ,'/',img/@src)" />
									<IMG width="100%" SRC="{$img}" />
								</TD>
							</TR>
							<TR>
								<TD class="w-100 p-3" COLSPAN="2">
									Channel name :
									<xsl:value-of select="channel/@name" />
								</TD>
							</TR>
							<TR>
								<TD class="w-100 p-3" COLSPAN="2">
									Timeline :
									<xsl:value-of select="timeLine" />
								</TD>
							</TR>
							<xsl:choose>
								<xsl:when test="element/@tag != ''">
									<TR>
										<TD class="w-100 p-3" COLSPAN="2">
											Element tag :
											<xsl:value-of select="element/@tag" />
										</TD>
									</TR>
								</xsl:when>
							</xsl:choose>
							<xsl:choose>
								<xsl:when test="element/criterias != ''">
									<TR>
										<TD class="w-100 p-3" COLSPAN="2">
											Criterias :
											<xsl:value-of select="element/criterias" />
										</TD>
									</TR>
								</xsl:when>
							</xsl:choose>
							
														<xsl:choose>
								<xsl:when test="data != ''">
	<TR>
	  <TD class="w-100 p-3" COLSPAN="2">
            Data :
            <xsl:value-of select="data"/>            
	  </TD>
	</TR>
	</xsl:when>
							</xsl:choose>
						</TBODY>
			</TABLE>
		</div>
		</xsl:when>
				</xsl:choose>
	</xsl:template>
</xsl:stylesheet>