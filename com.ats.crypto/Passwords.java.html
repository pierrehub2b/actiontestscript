<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Passwords.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ats-automated-testing</a> &gt; <a href="index.source.html" class="el_package">com.ats.crypto</a> &gt; <span class="el_source">Passwords.java</span></div><h1>Passwords.java</h1><pre class="source lang-java linenums">/*
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
&quot;License&quot;); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
&quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
 */

package com.ats.crypto;

import org.bouncycastle.crypto.BufferedBlockCipher;
import org.bouncycastle.crypto.engines.AESEngine;
import org.bouncycastle.crypto.modes.CBCBlockCipher;
import org.bouncycastle.crypto.paddings.PaddedBufferedBlockCipher;
import org.bouncycastle.crypto.params.KeyParameter;

import java.io.*;
import java.nio.file.Files;
import java.nio.file.Path;
import java.security.NoSuchAlgorithmException;
import java.security.SecureRandom;
import java.util.Base64;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.stream.Collectors;

//-----------------------------------------------------------------------------------------------------------------
// Very simple class to encrypt passwords data /!\ DO NOT USE for very strong encryption or security needs /!\
//-----------------------------------------------------------------------------------------------------------------

public class Passwords implements Serializable {

	private static final long serialVersionUID = -2364261599407176796L;

	private static final String FILE_NAME = &quot;passwords.crypto&quot;;

<span class="fc" id="L49">	private transient static BufferedBlockCipher cipher = new PaddedBufferedBlockCipher(new CBCBlockCipher(new AESEngine()));</span>

	private transient File file;

<span class="fc" id="L53">	private int keyLen = 16;</span>
	private byte[] masterKey;
<span class="fc" id="L55">	private HashMap&lt;String, byte[]&gt; data = new HashMap&lt;String, byte[]&gt;();</span>

<span class="fc" id="L57">	public Passwords(Path assetsPath) {</span>

<span class="fc" id="L59">		file = assetsPath.resolve(&quot;secret&quot;).resolve(FILE_NAME).toFile();</span>
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">		if(file.exists()) {</span>
<span class="nc" id="L61">			load();</span>
		}else {
<span class="fc" id="L63">			save();</span>
		}
<span class="fc" id="L65">	}</span>

<span class="fc" id="L67">	public Passwords(File assetsFolder) {</span>
		try {
<span class="fc" id="L69">			file = assetsFolder.toPath().resolve(&quot;secret&quot;).resolve(FILE_NAME).toFile();</span>
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">			if(file.exists()) {</span>
<span class="fc" id="L71">				load();</span>
			}else {
<span class="nc" id="L73">				file = null;</span>
			}
<span class="nc" id="L75">		}catch(Exception e) {</span>
<span class="nc" id="L76">			file = null;</span>
<span class="fc" id="L77">		}</span>
<span class="fc" id="L78">	}</span>

	public void setPassword(String key, String value) {
<span class="fc" id="L81">		data.put(key, value.getBytes());</span>
<span class="fc" id="L82">		save();</span>
<span class="fc" id="L83">		load();</span>
<span class="fc" id="L84">	}</span>

	public String getPassword(String key) {
<span class="pc bpc" id="L87" title="2 of 4 branches missed.">		if(file != null &amp;&amp; data.containsKey(key)) {</span>
<span class="fc" id="L88">			return new String(data.get(key)).replaceAll(&quot;\0&quot;, &quot;&quot;);</span>
		}
<span class="nc" id="L90">		return &quot;&quot;;</span>
	}

	public PasswordData[] getDataList() {

<span class="nc" id="L95">		final List&lt;String&gt; keySet = data.keySet().stream().collect(Collectors.toList());</span>
<span class="nc" id="L96">		Collections.sort(keySet, (o1, o2) -&gt; o1.compareTo(o2));</span>

<span class="nc" id="L98">		final PasswordData[] result = new PasswordData[data.size()];</span>
<span class="nc" id="L99">		int loop = 0;</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">		for(String key : keySet) {</span>
<span class="nc" id="L101">			result[loop] = new PasswordData(key, getPassword(key));</span>
<span class="nc" id="L102">			loop++;</span>
<span class="nc" id="L103">		}</span>
<span class="nc" id="L104">		return result;</span>
	}

	public void clear() {
<span class="nc" id="L108">		data.clear();</span>
<span class="nc" id="L109">	}</span>

	//-----------------------------------------------------------------------------------------------------------
	//
	//-----------------------------------------------------------------------------------------------------------

	private void load() {
		try {

<span class="fc" id="L118">			byte[] fileContent = Base64.getDecoder().decode(Files.readAllBytes(file.toPath()));</span>

<span class="fc" id="L120">			ByteArrayInputStream bis = new ByteArrayInputStream(fileContent);</span>

<span class="fc" id="L122">			byte[] key = new byte[keyLen];</span>
<span class="fc" id="L123">			bis.read(key, 0, keyLen);</span>

<span class="fc" id="L125">			byte[] bytes = decrypt(key, bis.readAllBytes());</span>

<span class="fc" id="L127">			final ByteArrayInputStream byteStream = new ByteArrayInputStream(bytes);</span>
<span class="fc" id="L128">			final ObjectInputStream objStream = new ObjectInputStream(byteStream);</span>

<span class="fc" id="L130">			final Passwords pass = (Passwords) objStream.readObject();</span>
<span class="fc" id="L131">			this.data = pass.data;</span>
<span class="fc" id="L132">			this.masterKey = pass.masterKey;</span>

<span class="pc" id="L134">		} catch (IOException | ClassNotFoundException e) {}</span>

<span class="fc" id="L136">		data.replaceAll((k, v) -&gt; decrypt(masterKey, v));</span>
<span class="fc" id="L137">	}</span>

	private void save() {
		try {

<span class="fc" id="L142">			file.getParentFile().mkdirs();			</span>

<span class="fc" id="L144">			final byte[] randomKey = new byte[keyLen];</span>
<span class="fc" id="L145">			masterKey = new byte[keyLen];</span>

<span class="fc" id="L147">			final SecureRandom random = SecureRandom.getInstanceStrong();</span>
<span class="fc" id="L148">			random.nextBytes(randomKey);</span>
<span class="fc" id="L149">			random.nextBytes(masterKey);</span>

<span class="fc" id="L151">			data.replaceAll((k, v) -&gt; encrypt(masterKey, v));</span>

<span class="fc" id="L153">			ByteArrayOutputStream bos = new ByteArrayOutputStream();</span>
<span class="fc" id="L154">			final ObjectOutput out = new ObjectOutputStream(bos);  </span>
<span class="fc" id="L155">			out.writeObject(this);</span>

<span class="fc" id="L157">			final byte[] dataBytes = encrypt(randomKey, bos.toByteArray());</span>
<span class="fc" id="L158">			out.close();</span>
<span class="fc" id="L159">			bos.close();</span>

<span class="fc" id="L161">			bos = new ByteArrayOutputStream();</span>
<span class="fc" id="L162">			bos.write(randomKey);</span>
<span class="fc" id="L163">			bos.write(dataBytes);</span>

<span class="fc" id="L165">			final FileOutputStream outfile = new FileOutputStream(file);</span>
<span class="fc" id="L166">			outfile.write(Base64.getEncoder().encode(bos.toByteArray()));</span>
<span class="fc" id="L167">			outfile.close();</span>

<span class="nc" id="L169">		} catch (NoSuchAlgorithmException | IOException e) {</span>

<span class="nc" id="L171">			System.out.println(e.getMessage());</span>
<span class="fc" id="L172">		} </span>
<span class="fc" id="L173">	}</span>

	private static byte[] encrypt(byte[] key, byte[] data) {
<span class="fc" id="L176">		cipher.init(true, new KeyParameter(key));</span>
<span class="fc" id="L177">		byte[] rv = new byte[cipher.getOutputSize(data.length)];</span>
<span class="fc" id="L178">		int tam = cipher.processBytes(data, 0, data.length, rv, 0);</span>
		try {
<span class="fc" id="L180">			cipher.doFinal(rv, tam);</span>
<span class="nc" id="L181">		} catch (Exception ce) {</span>
<span class="nc" id="L182">			ce.printStackTrace();</span>
<span class="fc" id="L183">		}</span>
<span class="fc" id="L184">		return rv;</span>
	}

	private byte[] decrypt(byte[] key, byte[] data) {
<span class="fc" id="L188">		cipher.init(false, new KeyParameter(key));</span>
<span class="fc" id="L189">		byte[] rv = new byte[cipher.getOutputSize(data.length)];</span>
<span class="fc" id="L190">		int tam = cipher.processBytes(data, 0, data.length, rv, 0);</span>
		try {
<span class="fc" id="L192">			cipher.doFinal(rv, tam);</span>
<span class="nc" id="L193">		} catch (Exception ce) {</span>
<span class="nc" id="L194">			ce.printStackTrace();</span>
<span class="fc" id="L195">		}</span>
<span class="fc" id="L196">		return rv;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>